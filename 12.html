<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期刊分区查询系统</title>
    <style>
        /* 样式部分与之前相同，保持不变 */
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .search-box {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        #search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        #search-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #search-btn:hover {
            background-color: #2980b9;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-group {
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #results {
            margin-top: 20px;
            overflow-x: auto;
        }
        .result-count {
            margin-bottom: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 1000px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        th:hover {
            background-color: #2980b9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .jcr-q1 {
            background-color: #e8f5e9;
        }
        .jcr-q2 {
            background-color: #e3f2fd;
        }
        .jcr-q3 {
            background-color: #fff8e1;
        }
        .jcr-q4 {
            background-color: #ffebee;
        }
        .cas-1 {
            background-color: #e8f5e9;
        }
        .cas-2 {
            background-color: #e3f2fd;
        }
        .cas-3 {
            background-color: #fff8e1;
        }
        .cas-4 {
            background-color: #ffebee;
        }
        .no-results {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            font-weight: bold;
        }
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .highlight {
            background-color: #fffde7;
            font-weight: bold;
        }
        .jif-value {
            font-weight: bold;
            color: #2e7d32;
        }
        @media (max-width: 768px) {
            .search-box, .filters {
                flex-direction: column;
            }
            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>期刊分区查询系统</h1>
        
        <div class="instructions">
            <h3>使用说明：</h3>
            <ol>
                <li>确保期刊数据文件(journals.xlsx)与HTML文件在同一目录</li>
                <li>在搜索框中输入期刊名称、ISSN或学科关键词</li>
                <li>使用筛选器缩小查询范围</li>
                <li>点击"搜索"按钮查看结果</li>
                <li>点击表头可以排序</li>
            </ol>
            <p>系统将自动加载同目录下的journals.xlsx文件</p>
        </div>
        
        <div class="search-box">
            <input type="text" id="search-input" placeholder="输入期刊名称、ISSN或学科关键词...">
            <button id="search-btn">搜索</button>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="category-filter">学科分类:</label>
                <select id="category-filter">
                    <option value="">所有学科</option>
                    <!-- 动态填充 -->
                </select>
            </div>
            <div class="filter-group">
                <label for="jcr-filter">JCR分区:</label>
                <select id="jcr-filter">
                    <option value="">所有分区</option>
                    <option value="Q1">Q1</option>
                    <option value="Q2">Q2</option>
                    <option value="Q3">Q3</option>
                    <option value="Q4">Q4</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="cas-filter">中科院分区:</label>
                <select id="cas-filter">
                    <option value="">所有分区</option>
                    <option value="1">1区</option>
                    <option value="2">2区</option>
                    <option value="3">3区</option>
                    <option value="4">4区</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="jif-range">JIF范围:</label>
                <select id="jif-range">
                    <option value="">所有</option>
                    <option value="10">10以上</option>
                    <option value="5">5-10</option>
                    <option value="3">3-5</option>
                    <option value="1">1-3</option>
                    <option value="0">1以下</option>
                </select>
            </div>
        </div>
        
        <div id="results">
            <div class="result-count" id="result-count">共找到 0 条记录</div>
            <div id="results-table">
                <table>
                    <thead>
                        <tr>
                            <th data-sort="journal">期刊名称</th>
                            <th data-sort="issn">ISSN</th>
                            <th data-sort="eissn">eISSN</th>
                            <th data-sort="category">学科分类</th>
                            <th data-sort="jif" class="sortable">2024JIF ↓</th>
                            <th data-sort="jcr">JCR 2024</th>
                            <th data-sort="cas">中科院 2025</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // 全局变量存储期刊数据
        let journalData = [];
        let categories = new Set();
        let currentSort = { column: 'jif', direction: 'desc' };
        
        // DOM元素
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const categoryFilter = document.getElementById('category-filter');
        const jcrFilter = document.getElementById('jcr-filter');
        const casFilter = document.getElementById('cas-filter');
        const jifRangeFilter = document.getElementById('jif-range');
        const resultsBody = document.getElementById('results-body');
        const resultCount = document.getElementById('result-count');
        const tableHeaders = document.querySelectorAll('th[data-sort]');
        
        // 加载本地Excel文件
        function loadLocalExcelFile() {
            const url = 'data/journals.xlsx'; // 本地Excel文件名
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`无法加载文件: ${response.statusText}`);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // 转换为JSON
                    journalData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // 标准化字段名
                    journalData = standardizeFieldNames(journalData);
                    
                    // 提取学科用于筛选器
                    extractFilterOptions();
                    
                    // 填充筛选器
                    populateFilters();
                    
                    // 初始搜索
                    searchJournals();
                    
                    console.log(`成功加载 ${journalData.length} 条期刊数据`);
                })
                .catch(error => {
                    console.error('加载Excel文件失败:', error);
                    alert('加载期刊数据失败，请确保journals.xlsx文件存在并与本页面在同一目录下');
                });
        }
        
        // 标准化字段名
        function standardizeFieldNames(data) {
            return data.map(item => {
                const standardized = {};
                
                // 统一字段名
                standardized.journal = item['期刊名'] || item['Journal Name'] || item['期刊名称'] || '';
                standardized.issn = item['ISSN'] || '';
                standardized.eissn = item['eISSN'] || '';
                standardized.category = item['Category'] || item['学科分类'] || '';
                standardized.jif = parseFloat(item['2024JIF'] || item['JIF'] || 0);
                standardized.jcr = item['JCR 2024'] || item['JCR分区'] || '';
                standardized.cas = item['中科院 2025'] || item['中科院分区'] || '';
                
                return standardized;
            });
        }
        
        // 提取筛选选项
        function extractFilterOptions() {
            categories.clear();
            
            journalData.forEach(journal => {
                if (journal.category) categories.add(journal.category);
            });
        }
        
        // 填充筛选器
        function populateFilters() {
            // 填充学科筛选器
            categoryFilter.innerHTML = '<option value="">所有学科</option>';
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }
        
        // 搜索期刊
        function searchJournals() {
            const query = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            const jcr = jcrFilter.value;
            const cas = casFilter.value;
            const jifRange = jifRangeFilter.value;
            
            // 过滤数据
            let filteredData = journalData.filter(journal => {
                // 搜索条件
                const matchesSearch = 
                    query === '' || 
                    journal.journal.toLowerCase().includes(query) ||
                    journal.issn.toLowerCase().includes(query) ||
                    journal.eissn.toLowerCase().includes(query) ||
                    (journal.category && journal.category.toLowerCase().includes(query));
                
                // 学科条件
                const matchesCategory = !category || journal.category === category;
                
                // JCR分区条件
                const matchesJcr = !jcr || journal.jcr === jcr;
                
                // 中科院分区条件
                const matchesCas = !cas || journal.cas.includes(cas);
                
                // JIF范围条件
                let matchesJifRange = true;
                if (jifRange) {
                    const jif = journal.jif || 0;
                    switch(jifRange) {
                        case '10': matchesJifRange = jif >= 10; break;
                        case '5': matchesJifRange = jif >= 5 && jif < 10; break;
                        case '3': matchesJifRange = jif >= 3 && jif < 5; break;
                        case '1': matchesJifRange = jif >= 1 && jif < 3; break;
                        case '0': matchesJifRange = jif < 1; break;
                    }
                }
                
                return matchesSearch && matchesCategory && matchesJcr && matchesCas && matchesJifRange;
            });
            
            // 排序数据
            sortData(filteredData);
            
            // 显示结果
            displayResults(filteredData);
        }
        
        // 排序数据
        function sortData(data) {
            const { column, direction } = currentSort;
            
            data.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // 特殊处理JIF排序
                if (column === 'jif') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                }
                
                // 处理字符串比较
                if (typeof valueA === 'string') valueA = valueA.toLowerCase();
                if (typeof valueB === 'string') valueB = valueB.toLowerCase();
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        // 显示结果
        function displayResults(data) {
            resultsBody.innerHTML = '';
            
            if (data.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="7" class="no-results">没有找到匹配的期刊</td></tr>';
                resultCount.textContent = '共找到 0 条记录';
                return;
            }
            
            resultCount.textContent = `共找到 ${data.length} 条记录`;
            
            const query = searchInput.value.toLowerCase();
            
            data.forEach(journal => {
                const row = document.createElement('tr');
                
                // 根据分区添加CSS类
                if (journal.jcr) {
                    const jcrClass = `jcr-${journal.jcr.toLowerCase()}`;
                    row.classList.add(jcrClass);
                }
                
                if (journal.cas) {
                    const casClass = `cas-${journal.cas.charAt(0)}`; // 取中科院分区的第一个字符
                    row.classList.add(casClass);
                }
                
                // 高亮匹配搜索词的部分
                const highlightMatch = (text) => {
                    if (!query || !text) return text;
                    const lowerText = text.toLowerCase();
                    const index = lowerText.indexOf(query);
                    if (index === -1) return text;
                    
                    const before = text.substring(0, index);
                    const match = text.substring(index, index + query.length);
                    const after = text.substring(index + query.length);
                    
                    return `${before}<span class="highlight">${match}</span>${after}`;
                };
                
                // 填充单元格
                row.innerHTML = `
                    <td>${highlightMatch(journal.journal)}</td>
                    <td>${journal.issn || '-'}</td>
                    <td>${journal.eissn || '-'}</td>
                    <td>${journal.category || '-'}</td>
                    <td class="jif-value">${journal.jif ? journal.jif.toFixed(3) : '-'}</td>
                    <td>${journal.jcr || '-'}</td>
                    <td>${journal.cas || '-'}</td>
                `;
                
                resultsBody.appendChild(row);
            });
        }
        
        // 表头排序
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-sort');
                
                // 更新排序方向
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                
                // 更新表头箭头指示
                tableHeaders.forEach(h => {
                    h.innerHTML = h.textContent.replace(' ↑', '').replace(' ↓', '');
                    if (h.getAttribute('data-sort') === currentSort.column) {
                        h.innerHTML += currentSort.direction === 'asc' ? ' ↑' : ' ↓';
                    }
                });
                
                // 重新搜索
                searchJournals();
            });
        });
        
        // 事件监听
        searchBtn.addEventListener('click', searchJournals);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchJournals();
        });
        
        categoryFilter.addEventListener('change', searchJournals);
        jcrFilter.addEventListener('change', searchJournals);
        casFilter.addEventListener('change', searchJournals);
        jifRangeFilter.addEventListener('change', searchJournals);
        
        // 页面加载时自动读取本地Excel文件
        window.addEventListener('DOMContentLoaded', loadLocalExcelFile);
    </script>
</body>
</html>